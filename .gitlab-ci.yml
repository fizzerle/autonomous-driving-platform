image: docker:stable

services:
  - docker:dind
variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
stages:
#  - build
  - deploy

#backend-maven-build:
#  image: maven:3.6.1-ibmjava-8-alpine
#  stage: build
#  script: "mvn install -Ddocker.registry=registry.gitlab.com/fizzerle/dse-2019-ss \
#           -Ddockerfile.username=gitlab-ci-token \
#           -Ddockerfile.password=$CI_BUILD_TOKEN -DskipTests -B"

kubernetes-deploy:
  image: google/cloud-sdk
  stage: deploy
  script:
    - echo "$GOOGLE_KEY" > key.json
    - gcloud auth activate-service-account --key-file key.json
    - gcloud config set compute/zone europe-west1-b
    - gcloud config set project dse19-group-11
    - gcloud config set container/use_client_certificate True
    - gcloud container clusters get-credentials dse-deploy-cluster --project dse19-group-11
    - kubectl delete secret registry.gitlab.com
    - kubectl create secret docker-registry registry.gitlab.com --docker-server=https://registry.gitlab.com --docker-username=gitlab-ci-token --docker-password=$CI_BUILD_TOKEN --docker-email=thomas.schallert94@gmail.com
    - kubectl apply -f deployment.yml --namespace=production
    - cd kubernetes/
    - kubectl apply -f mongo-secret.yaml
    